#!/usr/bin/env ruby
# Usage:
#
#      asset_uploader  [ --no-upload | --no-sign ]  target_prefix  asset asset...
#
#   Takes the files (or files under directories) named by asset... and uploads them
#   to S3, renaming each file to include a checksum. Prints the path for each
#   file uploaded.
#
#   The target_prefix specifies where the file is stored on S3. 
#
#   The --no-upload option prints the path but does not upload
#
#   The --no-sign option uploads the file with no checksum. Files uploaded with
#   no checksum will be hard to change, as the caching front end won't know they
#   have changed
#
#   You need to set the S3 credentials in your environment
#
#       export AU_ACCESS_KEY_ID=...
#       export SECRET_ACCESS_KEY=...
#       export AU_BUCKET_NAME=...
#
#   The default bucket name for assets is a-origin.pragprog.com
#
# Examples
#
#   asset_uploader  magazines/2012-06/images  images
#
#   asset_uploader  --no-sign newsletter/2012-06-04 newsletter.html

require 'optparse'

begin
  gem 'asset_uploader' 
rescue Gem::LoadError
end

require 'asset_uploader'

def usage
  STDERR.puts File.read(__FILE__).sub(/^\s*$.*/m, '').gsub(/^#/, '')
  exit
end

def process(prefix, asset, opt)
  au = AssetUploader.new(prefix, asset)
  au.sign if opt[:sign]
  if opt[:upload]
    s3_path = au.upload 
  else
    s3_path = au.target_path
  end
  puts "#{asset}\t#{s3_path}"
end

opt = { :upload => true, :sign => true }

parser = OptionParser.new
parser.on("-n", "--no-upload")  { opt[:upload] = false }
parser.on("-u", "--no-sign" )   { opt[:sign]   = false }
parser.on("-h", "--help")       { usage }

params = parser.parse(ARGV)
prefix = params.shift || usage

until params.empty?
  asset = params.shift
  if File.directory?(asset)
    Dir.glob("#{asset}/*").each {|f| params.unshift(f) }
  else
    process(prefix, asset, opt)
  end
end
